import pytest
import numpy as np

from naplib.features import auditory_spectrogram

@pytest.fixture(scope='module')
def small_sound():
    fs = 10000
    t = 1
    f = 800
    samples = np.linspace(0, t, int(fs*t), endpoint=False)
    signal = np.sin(2 * np.pi * f * samples)
    return signal

def test_small_sound_linear_factor(small_sound):
    aud = auditory_spectrogram(small_sound, 10000, frame_len=8, tc=4, factor='linear')
    assert aud.shape[1] == 128

    aud_truth_last_row = np.array([0.00211697739766943, 0.00256581799559363, 0.00261909938936342, 0.00327043889170548, 0.00259038899220435, 0.00234611890369527, 0.00346602844663060, 0.00378452498891300, 0.00240466120369468, 0.00326137475344449, 0.00572826472992262, 0.00481152586272712, 0.00465721435389177, 0.00237542662853430, 0.00325943750539503, 0.00467834402156662, 0.00313280562250488, 0.00925637674526420, 0.00316187529441828, 0.00304656128715561, 0.00317264768929726, 0.00268358790313583, 0.00613327874124360, 0.00305879320755657, 0.00366317718976252, 0.00319580085666524, 0.00468147402361829, 0.00419217179634447, 0.00252286912306284, 0.00701225861585447, 0.00307424023564473, 0.00652950934974268, 0.00495015196447539, 0.00518733202901122, 0.00534333494499368, 0.00556179529193579, 0.00579151169433515, 0.00531818002576087, 0.00706935324892189, 0.0105064142563699, 0.0102143817191099, 0.00636215434178227, 0.00688639739394692, 0.0107592326392697, 0.00855690982419889, 0.00860758519055081, 0.00809107331064542, 0.00789405164841798, 0.0100778240865144, 0.0148528140455357, 0.00812219596853356, 0.0124363532621855, 0.0110777493920390, 0.0134060285800358, 0.0163988154045932, 0.0182004843919482, 0.0124591593707339, 0.0502360489620307, 0.0184807179723523, 0.0220733459265280, 0.0258533992552130, 0.0313311964090539, 0.0323560143070651, 0.0396504801917889, 0.0509426484608303, 0.0632245519262265, 0.0514347710758086, 0.113678152821373, 0.126134615884676, 0.113702138660377, 0.118399108436422, 0.442725155553168, 2.39861326097915, 8.32940368324315, 8.45131572440777, 5.00084614490890, 3.32569706653483, 2.35933063726623, 1.67996157969682, 1.27192440118804, 1.03504545126247, 0.805949418582036, 0.686231528276526, 0.578828896363868, 0.489921644591362, 0.418337966103116, 0.362024641969939, 0.313926421438699, 0.271957486330750, 0.236306200731824, 0.207326729259668, 0.181121704013345, 0.162171048982547, 0.144649883456355, 0.128465106274622, 0.116264786177448, 0.104765024086033, 0.0949849474872676, 0.0867034562395977, 0.0793772046016372, 0.0733986985629914, 0.0671747180218126, 0.0637279033633431, 0.0579978328530447, 0.0562110292217192, 0.0382123989481837, 0.0842564259405137, 0.0255427092257705, 0.0470549609085425, 0.0453068697712253, 0.0415020203556982, 0.0349465616064414, 0.0438286711746315, 0.0375704971124847, 0.0358826045294785, 0.0359415349577885, 0.0345982141262045, 0.0324244507436489, 0.0349854718051640, 0.0320349632333764, 0.0324835793656250, 0.0314430672797667, 0.0313969298704254, 0.0306073657378193, 0.0304504688142814, 0.0303952306043002, 0.0285030498694308, 0.0331345069381866])
    assert np.allclose(aud[-1,:], aud_truth_last_row)

