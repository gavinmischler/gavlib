import pytest
import numpy as np

from naplib.features import auditory_spectrogram

@pytest.fixture(scope='module')
def small_sound():
    fs = 10000
    t = 1
    f = 800
    samples = np.linspace(0, t, int(fs*t), endpoint=False)
    signal = np.sin(2 * np.pi * f * samples)
    return signal

def test_small_sound_linear_factor(small_sound):
    aud = auditory_spectrogram(small_sound, 10000, frame_len=8, tc=4, factor='linear')
    assert aud.shape[1] == 128
    aud_truth_last_row = np.array([0.00211697739766943, 0.00256581799559363, 0.00261909938936342, 0.00327043889170548, 0.00259038899220435, 0.00234611890369527, 0.00346602844663060, 0.00378452498891300, 0.00240466120369468, 0.00326137475344449, 0.00572826472992262, 0.00481152586272712, 0.00465721435389177, 0.00237542662853430, 0.00325943750539503, 0.00467834402156662, 0.00313280562250488, 0.00925637674526420, 0.00316187529441828, 0.00304656128715561, 0.00317264768929726, 0.00268358790313583, 0.00613327874124360, 0.00305879320755657, 0.00366317718976252, 0.00319580085666524, 0.00468147402361829, 0.00419217179634447, 0.00252286912306284, 0.00701225861585447, 0.00307424023564473, 0.00652950934974268, 0.00495015196447539, 0.00518733202901122, 0.00534333494499368, 0.00556179529193579, 0.00579151169433515, 0.00531818002576087, 0.00706935324892189, 0.0105064142563699, 0.0102143817191099, 0.00636215434178227, 0.00688639739394692, 0.0107592326392697, 0.00855690982419889, 0.00860758519055081, 0.00809107331064542, 0.00789405164841798, 0.0100778240865144, 0.0148528140455357, 0.00812219596853356, 0.0124363532621855, 0.0110777493920390, 0.0134060285800358, 0.0163988154045932, 0.0182004843919482, 0.0124591593707339, 0.0502360489620307, 0.0184807179723523, 0.0220733459265280, 0.0258533992552130, 0.0313311964090539, 0.0323560143070651, 0.0396504801917889, 0.0509426484608303, 0.0632245519262265, 0.0514347710758086, 0.113678152821373, 0.126134615884676, 0.113702138660377, 0.118399108436422, 0.442725155553168, 2.39861326097915, 8.32940368324315, 8.45131572440777, 5.00084614490890, 3.32569706653483, 2.35933063726623, 1.67996157969682, 1.27192440118804, 1.03504545126247, 0.805949418582036, 0.686231528276526, 0.578828896363868, 0.489921644591362, 0.418337966103116, 0.362024641969939, 0.313926421438699, 0.271957486330750, 0.236306200731824, 0.207326729259668, 0.181121704013345, 0.162171048982547, 0.144649883456355, 0.128465106274622, 0.116264786177448, 0.104765024086033, 0.0949849474872676, 0.0867034562395977, 0.0793772046016372, 0.0733986985629914, 0.0671747180218126, 0.0637279033633431, 0.0579978328530447, 0.0562110292217192, 0.0382123989481837, 0.0842564259405137, 0.0255427092257705, 0.0470549609085425, 0.0453068697712253, 0.0415020203556982, 0.0349465616064414, 0.0438286711746315, 0.0375704971124847, 0.0358826045294785, 0.0359415349577885, 0.0345982141262045, 0.0324244507436489, 0.0349854718051640, 0.0320349632333764, 0.0324835793656250, 0.0314430672797667, 0.0313969298704254, 0.0306073657378193, 0.0304504688142814, 0.0303952306043002, 0.0285030498694308, 0.0331345069381866])
    assert np.allclose(aud[-1,:], aud_truth_last_row, rtol=1e-2)

def test_small_sound_halfwave_factor(small_sound):
    aud = auditory_spectrogram(small_sound, 10000, frame_len=8, tc=4, factor='half-wave')
    aud_truth_last_row = np.array([5.42372006440619e-05, 0.000184456218358891, 5.99836264099009e-85, 3.57819860662479e-05, 1.39638144754524e-86, 0.000594548955129965, 0.000449203449507932, 1.72282477697418e-07, 8.20552955434370e-05, 3.36777996859162e-90, 2.59510937603746e-07, 0.00528469467335122, 1.28588760142306e-91, 5.74874998512013e-92, 0.00396347544345059, 2.29844533612066e-94, 0.00250893577620760, 1.75547841593965e-97, 0.00201259363191681, 8.46387184130465e-97, 1.63323743534477e-97, 1.16602859701279e-05, 1.21277621095486e-99, 1.64379383831657e-98, 2.52225448977810e-99, 2.72953594811890e-99, 3.08314029333231e-100, 1.50378560894338e-100, 1.04828928528079e-98, 4.54400869625090e-102, 7.37262498221504e-101, 8.24366921867354e-103, 1.75060910693615e-102, 4.56244763336304e-103, 3.40823015788619e-103, 2.91549688719834e-103, 1.12385840278821e-103, 5.04540368897374e-104, 1.38857991332975e-104, 4.57080225513265e-105, 2.19224058605455e-105, 6.36996312319016e-105, 2.84224484561621e-105, 5.14501880422574e-106, 7.15973609889750e-106, 4.73788504133890e-106, 1.93036270453020e-106, 2.49779557590601e-106, 2.89743746769802e-107, 5.56821630616112e-107, 9.49076265501525e-107, 1.38812524823968e-107, 4.24517531436799e-107, 1.28869827083702e-107, 7.08861950572574e-108, 4.32379356198633e-108, 7.67766042321929e-108, 3.33042755480838e-109, 0.0659959277663167, 1.37526708284497e-108, 9.15799091152067e-109, 2.18541622962239e-06, 7.71518915134623e-109, 4.55239233095300e-109, 4.40911741013497e-109, 2.95111028274206e-109, 4.01056390253457e-109, 1.84966450598001e-109, 1.86884191968771e-109, 2.51320384348247e-109, 0.000258855593134810, 0.321275527350659, 4.74126238343046e-113, 3.06132435421788e-112, 7.34905607996268, 7.08006445665781, 6.15883055345071, 5.28582695240107, 4.20642411332527, 3.10168166881600, 2.52344259045423, 2.49434830120544, 1.90512040744475, 1.61280831026558, 1.48392797732806, 1.36289944955123, 1.23038103029744, 1.09699649550397, 0.964681503116217, 0.842474517884400, 0.741243633079068, 0.655567710545620, 0.592620412912848, 0.545220436785157, 0.489574255641556, 0.455236836452125, 0.413240163789661, 0.384608263822792, 0.347105170769831, 0.324627576351117, 0.302700866243097, 0.278154697238251, 0.264298781688201, 0.244996758497096, 0.235259107439805, 0.162709006645071, 0.343889541258879, 0.111265829393736, 0.201435073221807, 0.195723111339812, 0.178715075855256, 0.149747426763488, 0.190053400598594, 0.163850151839076, 0.156460818915653, 0.154773063728843, 0.146901368890077, 0.137250111510869, 0.139717320270238, 0.129371910642607, 0.123502957627590, 0.116014119513572, 0.108039534051005, 0.100901841959821, 0.0922940696409943, 0.0847690881624114, 0.0729539636123131, 0.0759988845565765])
    assert np.allclose(aud[-1,:], aud_truth_last_row, rtol=1e-2)