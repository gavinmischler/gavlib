import pytest
import numpy as np

from naplib.features import auditory_spectrogram

@pytest.fixture(scope='module')
def small_sound():
    fs = 10000
    t = 1
    f = 800
    samples = np.linspace(0, t, int(fs*t), endpoint=False)
    signal = np.sin(2 * np.pi * f * samples)
    return signal

def test_small_sound_linear_factor(small_sound):
    aud = auditory_spectrogram(small_sound, 10000, frame_len=8, tc=4, factor='linear')
    assert aud.shape[0] == 157
    assert aud.shape[1] == 128

    aud_truth_last_row = np.array([0.00127752575424100, 0.000587155334559026, 0.000602010104552484, 0.00185327070317546, 0.00137293116056963, 0.000618488673293554, 0.00114732363055792, 0.00400709755664217, 0.00237473062927841, 0.00555400747636673, 0.00924259359983873, 0.00592726263689263, 0.0115446818787214, 0.0106439412823504, 0.0123767787606906, 0.0183176598769299, 0.0180367103384842, 0.0272253638419697, 0.0235714082113680, 0.0282571607068109, 0.0309430042304616, 0.0325447460249311, 0.0376028106344373, 0.0372144079099082, 0.0386569289036963, 0.0384854751754904, 0.0387098305776204, 0.0372512608939761, 0.0351217737442058, 0.0370370913486901, 0.0339272921788247, 0.0350598228129861, 0.0335617369601570, 0.0330455017138833, 0.0325545102287175, 0.0321224738060258, 0.0317473844447038, 0.0311107810231024, 0.0315187801504867, 0.0322292665785863, 0.0351492259353386, 0.0359729862669295, 0.0449327262536356, 0.0614890631489059, 0.0756043996462441, 0.0930556699574861, 0.110685946276381, 0.123998314469557, 0.135532369673502, 0.136591801712349, 0.137370599249369, 0.137732609500993, 0.134181264007830, 0.140908229308146, 0.145728078336523, 0.144558964304734, 0.156698751923846, 0.167865087349106, 0.224803501256918, 0.282332189217930, 0.369973984178632, 0.462999765881423, 0.547391684592184, 0.640680446903576, 1.00769496475112, 2.74696539588971, 7.07209992569060, 7.80122809635466, 4.50926240145764, 2.98870133195399, 1.96775434542339, 1.42542648473617, 1.05392959825182, 0.900248848978559, 0.795064820126282, 0.706080858116134, 0.581857429938857, 0.487531615126153, 0.419446637280560, 0.361729028889785, 0.339836987963135, 0.350462235436236, 0.299363892900166, 0.266055354267283, 0.233814481792538, 0.211779190210408, 0.211341939057176, 0.206021728792522, 0.184493430266783, 0.164383443257220, 0.151118191206779, 0.154736985597519, 0.146770421426837, 0.132395260368608, 0.122477649813741, 0.121627967837868, 0.118912171448688, 0.108811261803002, 0.100919691234892, 0.102195680577826, 0.0969131901788408, 0.0895638828320878, 0.0869935420072368, 0.0852956620390922, 0.0790234475498385, 0.0747799396888502, 0.0894345993203054, 0.0660366372725542, 0.0694991671195211, 0.0672466437040042, 0.0615373641451151, 0.0622929245936208, 0.0604982654376188, 0.0571816200309221, 0.0559117832620547, 0.0526765638159618, 0.0518461026325788, 0.0495253922230070, 0.0501246356515995, 0.0472104494499818, 0.0462406430337092, 0.0445707005235756, 0.0445837213657662, 0.0427808965707951, 0.0422267659271587, 0.0419218588755923, 0.0409006513534626, 0.0410055740480895])

    assert np.allclose(aud[-1,:], aud_truth_last_row)

